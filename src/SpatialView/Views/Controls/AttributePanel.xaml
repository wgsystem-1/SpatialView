<UserControl x:Class="SpatialView.Views.Controls.AttributePanel"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:vm="clr-namespace:SpatialView.ViewModels"
             mc:Ignorable="d" 
             d:DataContext="{d:DesignInstance Type=vm:AttributePanelViewModel, IsDesignTimeCreatable=False}"
             d:DesignHeight="300" d:DesignWidth="800">
    
    <Grid Background="{StaticResource SurfaceBrush}">
        <Grid.RowDefinitions>
            <!-- Header -->
            <RowDefinition Height="48"/>
            <!-- DataGrid -->
            <RowDefinition Height="*"/>
            <!-- Footer -->
            <RowDefinition Height="32"/>
        </Grid.RowDefinitions>
        
        <!-- Header -->
        <Border Grid.Row="0" 
                Background="{StaticResource BackgroundBrush}"
                BorderBrush="{StaticResource BorderBrush}" 
                BorderThickness="0,0,0,1">
            <Grid Margin="12,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="200"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <!-- Title -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                    <materialDesign:PackIcon Kind="Table" Width="24" Height="24" 
                                             Foreground="{StaticResource PrimaryBrush}"
                                             VerticalAlignment="Center"/>
                    <TextBlock Text="ì†ì„± í…Œì´ë¸”" FontSize="14" FontWeight="SemiBold"
                               Foreground="{StaticResource TextPrimaryBrush}"
                               Margin="8,0,16,0" VerticalAlignment="Center"/>
                </StackPanel>
                
                <!-- Layer Selection -->
                <ComboBox Grid.Column="1"
                          ItemsSource="{Binding Layers}"
                          SelectedItem="{Binding SelectedLayer}"
                          DisplayMemberPath="Name"
                          materialDesign:HintAssist.Hint="ë ˆì´ì–´ ì„ íƒ"
                          VerticalAlignment="Center"/>
                
                <Rectangle Grid.Column="2" Width="1" Height="24" 
                           Fill="{StaticResource BorderBrush}" Margin="16,0"/>
                
                <!-- Filter -->
                <Grid Grid.Column="3" VerticalAlignment="Center">
                    <TextBox Text="{Binding FilterText, UpdateSourceTrigger=PropertyChanged}"
                             materialDesign:HintAssist.Hint="ðŸ” ê²€ìƒ‰..."
                             materialDesign:TextFieldAssist.HasClearButton="True"
                             Height="32"/>
                </Grid>
                
                <!-- Actions -->
                <StackPanel Grid.Column="4" Orientation="Horizontal" Margin="8,0,0,0">
                    <!-- Field Management -->
                    <Button Style="{StaticResource MaterialDesignIconButton}"
                            Command="{Binding AddFieldCommand}"
                            ToolTip="í•„ë“œ ì¶”ê°€"
                            Width="32" Height="32">
                        <materialDesign:PackIcon Kind="TableColumnPlusAfter" Width="18" Height="18"/>
                    </Button>
                    <Button Style="{StaticResource MaterialDesignIconButton}"
                            Click="DeleteField_Click"
                            ToolTip="í•„ë“œ ì‚­ì œ"
                            Width="32" Height="32">
                        <materialDesign:PackIcon Kind="TableColumnRemove" Width="18" Height="18"/>
                    </Button>
                    <Button Style="{StaticResource MaterialDesignIconButton}"
                            Command="{Binding OpenFieldCalculatorCommand}"
                            ToolTip="í•„ë“œ ê³„ì‚°ê¸°"
                            Width="32" Height="32">
                        <materialDesign:PackIcon Kind="Calculator" Width="18" Height="18"/>
                    </Button>
                    
                    <Rectangle Width="1" Height="20" Fill="{StaticResource BorderBrush}" Margin="4,0"/>

                    <Button Style="{StaticResource MaterialDesignIconButton}"
                            Command="{Binding SaveTableCommand}"
                            ToolTip="ë³€ê²½ì‚¬í•­ ì €ìž¥ (ì›ë³¸ íŒŒì¼ì— ì €ìž¥)"
                            Width="32" Height="32">
                        <Grid>
                            <materialDesign:PackIcon Kind="ContentSave" Width="18" Height="18"/>
                            <!-- ë³€ê²½ì‚¬í•­ í‘œì‹œê¸° -->
                            <Ellipse Width="8" Height="8" Fill="#FF5722"
                                     HorizontalAlignment="Right" VerticalAlignment="Top"
                                     Margin="0,-2,-2,0"
                                     Visibility="{Binding HasUnsavedChanges, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                        </Grid>
                    </Button>
                    <Button Style="{StaticResource MaterialDesignIconButton}"
                            Command="{Binding ExportTableCommand}"
                            ToolTip="í…Œì´ë¸” ë‚´ë³´ë‚´ê¸° (CSV/TSV)"
                            Width="32" Height="32">
                        <materialDesign:PackIcon Kind="FileExportOutline" Width="18" Height="18"/>
                    </Button>
                    <Button Style="{StaticResource MaterialDesignIconButton}"
                            Command="{Binding RefreshCommand}"
                            ToolTip="ìƒˆë¡œê³ ì¹¨"
                            Width="32" Height="32">
                        <materialDesign:PackIcon Kind="Refresh" Width="18" Height="18"/>
                    </Button>
                    <Button Style="{StaticResource MaterialDesignIconButton}"
                            Command="{Binding ClearSelectionCommand}"
                            ToolTip="ì„ íƒ í•´ì œ"
                            Width="32" Height="32">
                        <materialDesign:PackIcon Kind="SelectOff" Width="18" Height="18"/>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>
        
        <!-- DataGrid -->
        <DataGrid x:Name="AttributeDataGrid"
                  Grid.Row="1"
                  ItemsSource="{Binding AttributeTable}"
                  SelectedItem="{Binding SelectedRow}"
                  AutoGenerateColumns="True"
                  IsReadOnly="True"
                  CanUserAddRows="False"
                  CanUserDeleteRows="False"
                  CanUserReorderColumns="True"
                  CanUserResizeColumns="True"
                  CanUserSortColumns="True"
                  SelectionMode="Extended"
                  SelectionUnit="FullRow"
                  GridLinesVisibility="Horizontal"
                  HeadersVisibility="Column"
                  EnableRowVirtualization="True"
                  EnableColumnVirtualization="True"
                  VirtualizingPanel.IsVirtualizing="True"
                  VirtualizingPanel.VirtualizationMode="Recycling"
                  Background="Transparent"
                  BorderThickness="0"
                  MouseDoubleClick="DataGrid_MouseDoubleClick"
                  AutoGeneratingColumn="DataGrid_AutoGeneratingColumn">
            <DataGrid.Resources>
                <ContextMenu x:Key="ColumnHeaderContextMenu" x:Shared="False">
                    <MenuItem Header="í•„ë“œ ì‚­ì œ" Click="DeleteColumn_Click"/>
                </ContextMenu>
                <Style TargetType="DataGridColumnHeader" BasedOn="{StaticResource MaterialDesignDataGridColumnHeader}">
                    <Setter Property="Background" Value="{StaticResource BackgroundBrush}"/>
                    <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}"/>
                    <Setter Property="FontWeight" Value="SemiBold"/>
                    <Setter Property="Padding" Value="8,4"/>
                    <Setter Property="ContextMenu" Value="{StaticResource ColumnHeaderContextMenu}"/>
                </Style>
                <Style TargetType="DataGridCell" BasedOn="{StaticResource MaterialDesignDataGridCell}">
                    <Setter Property="Padding" Value="8,4"/>
                    <Style.Triggers>
                        <Trigger Property="IsSelected" Value="True">
                            <Setter Property="Background" Value="{StaticResource PrimaryLightBrush}"/>
                            <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}"/>
                        </Trigger>
                    </Style.Triggers>
                </Style>
            </DataGrid.Resources>
        </DataGrid>
        
        <!-- Loading Overlay -->
        <Border Grid.Row="1" 
                Background="#80FFFFFF"
                Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <ProgressBar IsIndeterminate="True" Width="100" Height="4"/>
                <TextBlock Text="ë¡œë”© ì¤‘..." Margin="0,8,0,0" 
                           Foreground="{StaticResource TextSecondaryBrush}"/>
            </StackPanel>
        </Border>
        
        <!-- Empty State -->
        <Border Grid.Row="1"
                Visibility="{Binding FeatureCount, Converter={StaticResource InverseIntToVisibilityConverter}}">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <materialDesign:PackIcon Kind="TableOff" Width="48" Height="48" 
                                         Foreground="{StaticResource TextSecondaryBrush}"
                                         HorizontalAlignment="Center"/>
                <TextBlock Text="{Binding StatusMessage}" 
                           Foreground="{StaticResource TextSecondaryBrush}"
                           FontSize="14" Margin="0,8,0,0"
                           HorizontalAlignment="Center"/>
            </StackPanel>
        </Border>
        
        <!-- Footer -->
        <Border Grid.Row="2" 
                Background="{StaticResource BackgroundBrush}"
                BorderBrush="{StaticResource BorderBrush}" 
                BorderThickness="0,1,0,0">
            <Grid Margin="12,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <!-- Feature Count -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="{Binding FeatureCount, StringFormat='{}{0:N0}ê°œ í”¼ì²˜'}" 
                               Foreground="{StaticResource TextSecondaryBrush}" FontSize="11"/>
                    <TextBlock Text=" | " Foreground="{StaticResource BorderBrush}" FontSize="11"
                               Margin="4,0"/>
                    <TextBlock Text="{Binding SelectedCount, StringFormat='{}{0:N0}ê°œ ì„ íƒ'}"
                               Foreground="{StaticResource PrimaryBrush}" FontSize="11"/>
                </StackPanel>
                
                <!-- Zoom to Selected -->
                <Button Grid.Column="1"
                        Style="{StaticResource MaterialDesignFlatButton}"
                        Command="{Binding ZoomToSelectedCommand}"
                        Content="ì„ íƒ í”¼ì²˜ë¡œ ì´ë™"
                        Height="28" Padding="8,0"/>
            </Grid>
        </Border>
    </Grid>
</UserControl>

